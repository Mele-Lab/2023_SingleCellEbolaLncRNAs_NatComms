---
title: "Untitled"
author: "Luisa Santus"
date: "2/28/2020"
output: html_document
---



# -------------------------------------
#       DEA
# -------------------------------------

```{r results='hide', message=FALSE, warning=FALSE}
library(edgeR)
library(stringr)
library(dplyr)
library(ggplot2)
library("wesanderson")
library(RColorBrewer)


# 0. Palettes & themes 
pal1 <- wes_palette("Darjeeling1", 8, type = "discrete")
pal2 <- wes_palette("Darjeeling2", 8, type = "discrete")
colfunc <- colorRampPalette(c("grey", "red"))

theme_paper <- theme(legend.title = element_blank())+theme(panel.background = element_rect(fill = "white", colour = "white"))+theme(panel.background = element_rect(fill = "white", colour = "grey50"))+theme(axis.text = element_text(size = 18), axis.title = element_text(size = 20), legend.text = element_text(size = 18))


# 1. Input Variables and Files
tissue <- "Lymph node"
outpath <- paste0("/home/luisas/Desktop/cluster/data/99_BroadAnnotation_Feb2021/05_DEA/Tissues/",tissue,"/")

# Sade objects
my_data <- readRDS(paste0(outpath,tissue,".voom_limma.data_objects.rds"))

dge <- my_data[["dge"]] 
v <- my_data[["v"]] 
fit <- my_data[["fit"]] 

FDRTHRESHOLD <- 0.05
```



# Explore dataset

```{r prcomp}
ggplot(metadata_tissue, aes(x = id.cohort,  y = pc.viral.reads, col =pc.viral.reads ))+geom_point(size = 2)+theme_paper+scale_color_continuous()
metadata_tissue$id.cohort <- factor(metadata_tissue$id.cohort, levels = c("D000", "D001", "D002", "D003", "D004", "D005","D006","D007","D008" ))

#-------------------------
#   Samples overview
#-------------------------

# Order samples by DPI 
df <- metadata_tissue[order(metadata_tissue$dpi_time_factor),]
df$X <- factor(df$X,levels = df$X)

variable <- "subtissue"
ggplot(df, aes(x = X, y = pc.viral.reads, col  =  eval(parse(text = variable)), fill = eval(parse(text = variable))))+geom_bar(stat = "identity")+theme_paper+xlab("Samples sorted by DPI")+ylab("% Viral read per sample")+theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())+ggtitle("Lymph node")+theme(title = element_text(size = 20))+scale_color_brewer(palette = "Set3")+scale_fill_brewer(palette = "Set3") +facet_grid(. ~ id.cohort, scales = "free_x") 

```

# Control samples are fine!

```{r prcomp}
# Viral count calculated by me
df_ebola <- merge(data.frame(viralcount = colSums(counts[grepl("EBOV", rownames(counts)),])), metadata_tissue, by = "row.names", all.x = F) 
ggplot(df_ebola, aes(x = viralReadCount,  y = viralcount ))+geom_point(size = 2)+theme_paper+scale_color_continuous()

# PROBLEM: my quantification not consistent
ggplot(df_ebola, aes(x = id.cohort,  y = viralcount, col =viralcount ))+geom_point(size = 2)+theme_paper+scale_color_continuous()
```


# Summary of DE Genes 

```{r prcomp}

# My questions are
# How many lncRNAs, PCs and Ebola genes are in the start set of analyzed genes 

# Expressed genes stats
exprs_genes



# General Summary: number of DE
n_de_summary <- data.frame(summary(decideTests(efit)))
names(n_de_summary) <- c("direction", "comparison", "n")
n_de_summary <- n_de_summary[n_de_summary$direction != "NotSig",]
n_de_summary$comparison <- factor(gsub("vsBaseline", "", n_de_summary$comparison) , levels = c("Early", "Middle", "Late"))
ggplot(n_de_summary, aes( x= comparison, fill = direction, y = n ) )+ geom_bar(stat = "identity", alpha = 0.7)+theme_paper+xlab("")+ylab("")+scale_fill_manual(values = rev(pal1[1:2]))+ggtitle("Number of DE genes")+theme(title = element_text(size =20 ))


res <- topTable(efit, coef = "LatevsBaseline", adjust.method = "fdr", confint = TRUE, n = Inf)
sig_de <- res[res$adj.P.Val < FDRTHRESHOLD, ]

# Check if Ebola genes are up-regulated 
sig_de[grepl("EBOV", rownames(sig_de)),]

res
table(grepl("EBOV", rownames(res)))




```




```{r prcomp}
library(org.Mmu.eg.db)
library(rtracklayer)


rownames(sig_de[sig_de$logFC < 0 ,])



do_go <- function(list, universe, keytype = "ENSEMBL"){
  ego <- clusterProfiler::enrichGO(gene = list,OrgDb =  org.Mmu.eg.db, keyType = keytype,ont = "BP",universe =universe)
  barplot(ego, showCategory=10)
  clusterProfiler::dotplot(ego)
}

universe <- unique(rownames(res)[!grepl("MSTRG", rownames(res))])
list <- rownames(sig_de[sig_de$logFC > 0,])
list <- unlist(lapply(list, function(x) strsplit(x,".", fixed = T)[[1]][1]))
list <- unique(list[!grepl("MSTRG", list)])

do_go(rownames(sig_de[sig_de$logFC > 0,]), rownames(fit))

keytypes(org.Mmu.eg.db)
```




















