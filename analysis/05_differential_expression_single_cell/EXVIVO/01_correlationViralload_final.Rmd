---
title: "Sc analysis"
author: "Luisa Santus"
date: "1/22/2020"
output: html_document
---


# Analysis on genes correlated with the viral load 

# 0. Imports 
```{r include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr); library(Seurat); library(Matrix); library(SingleCellExperiment)
library(stringr); library(rtracklayer); library(RColorBrewer); library(scales)
library(ggthemes); library(org.Mmu.eg.db); library(ggplot2); library(ggvenn)
library(ggExtra); library(Gviz); library(ggpubr); library(ggsci)


# Define paths for data
source("../../utils/00_datapaths.R")
source("../../utils/01_lncrna_annotation_utils.R")
source("../../utils/02_sc_utils.R")
source("../../utils/04_utils_graph.R")
source("../../utils/05_utils_corr.R")

theme_paper <- theme(panel.background = element_rect(fill = "white"), panel.grid.major = element_blank(), panel.grid.minor = element_blank())+theme(legend.text = element_text(size=10), legend.title = element_blank())

# --------------------------------
# Set thresholds 
RHOTHRESHOLD = 0.0
FDRTHRESHOLD<- 0.05

# ---------------------------------------------------
#           Load  references 
# ---------------------------------------------------
ref <- import(file.path(data_path, "01_bulk_RNA-Seq_lncRNAs_annotation/03_novel_lncRNAs_list/rheMac10_EBOV_and_novel_genenames_addedgenesNovel.gtf"))
orthologs <- readRDS(file.path(data_path, "/01_bulk_RNA-Seq_lncRNAs_annotation/05_orthologs/orthologs_geneid_ready.rds"))

# files ex vivo 
robjectsdir_stats <- file.path(data_path,"02_scRNA-Seq_PBMCs/00_scRNA-Seq_exVivo_rhemac10/05_RObjects/05_stats/")
all_lncrnas <- readRDS(file.path(robjectsdir_stats, "all_lncrnas.rds"))
annotated_mrnas <- readRDS(file.path(robjectsdir_stats,"annotated_mrnas.rds"))
ebola_genome_percentage_df_exvivo <- readRDS(file.path(data_path, "02_scRNA-Seq_PBMCs/00_scRNA-Seq_exVivo_rhemac10/05_RObjects/03_prep/df_viralpercentage.rds"))


all_lncrnas_invivo <- readRDS(file.path(data_path, "/02_scRNA-Seq_PBMCs/01_scRNA-Seq_inVivo_rhemac10/05_RObjects/05_stats/", "all_lncrnas.rds"))
annotated_mrnas_invivo <- readRDS(file.path(data_path, "/02_scRNA-Seq_PBMCs/01_scRNA-Seq_inVivo_rhemac10/05_RObjects/05_stats/", "annotated_mrnas.rds"))
ebola_genome_percentage_df_invivo <- readRDS(file.path(data_path, "02_scRNA-Seq_PBMCs/01_scRNA-Seq_inVivo_rhemac10/05_RObjects/03_prep/df_viralpercentage.rds"))


```



# 1. Load viral load correaltion files 
```{r imports}
# 1. Ex vivo no ebola 
# 1. Ex vivo no ebola 
correlations_exvivo_noebola <- readRDS(file.path(data_path, "02_scRNA-Seq_PBMCs/00_scRNA-Seq_exVivo_rhemac10/05_RObjects/06_correlation/03_viralload_infected_late/mono_infected_late_ebolaremoved_correlation.rds"))
filtered <- filter_significant_correlations(correlations_exvivo_noebola, ref, all_lncrnas, annotated_mrnas, FDRTHRESHOLD, RHOTHRESHOLD, usep = F)
correlations_exvivo_noebola <- filtered[[1]]
table(correlations_exvivo_noebola$type)
sig_cor_lnc_exvivo_noebola <- filtered[[2]]
#write.xlsx(sig_cor_lnc_exvivo_noebola, "/home/mariasr/cluster/02.ebola_sc/data/02_scRNA-Seq_PBMCs/00_scRNA-Seq_exVivo_rhemac10_NOVELFILTERTEST/05_RObjects/06_correlation/03_viralload_infected_late/sig_corr_lnc.xls", sheetName = "significant_lnc", col.names = TRUE, row.names = TRUE, append = FALSE)
mono_live_h24_inf_exvivo_noebola <- readRDS(file.path("~/cluster/02.ebola_sc/data/02_scRNA-Seq_PBMCs/00_scRNA-Seq_exVivo_rhemac10_NOVELFILTERTEST/05_RObjects/06_correlation/03_viralload_infected_late/mono_infected_late_ebolaremoved.rds"))


# 2. In vivo no ebola
mono_live_h24_inf_invivo_noebola <- readRDS(file.path(data_path, "02_scRNA-Seq_PBMCs/01_scRNA-Seq_inVivo_rhemac10/05_RObjects/06_correlation/03_viralload_infected_late/mono_log10TPT_late_ebolaremoved.rds"))
correlations_invivo_noebola <- readRDS(file.path(data_path, "02_scRNA-Seq_PBMCs/01_scRNA-Seq_inVivo_rhemac10/05_RObjects/06_correlation/03_viralload_infected_late/mono_infected_late_ebolaremoved_correlation_withzeros_log10TPT.rds"))
sig_cor_lnc_invivo_noebola <- filter_significant_correlations(correlations_invivo_noebola, ref, all_lncrnas_invivo, annotated_mrnas_invivo, FDRTHRESHOLD, RHOTHRESHOLD, usep = T)[[2]]
```


# 2. Plots
```{r imports}

# 1. Check how many are significantly up/down
plot_corr_genes_stat(correlations_exvivo_noebola)

# 2. Plot ex vivo genes
genes <- unique(sig_cor_lnc_exvivo_noebola$gene)
p_corr_exvivo_noebola <- visualize_correlation(genes, mono_live_h24_inf_exvivo_noebola,ebola_genome_percentage_df_exvivo, keepzeros = T)+ggtitle("EXVIVO")
p_corr_exvivo_noebola

#Plot 2 lncRNA positive
genes_positive <- c("ENSMMUG00000058644-unknown", "MSTRG.154583-unknown")
p_corr_exvivo_positive <- visualize_correlation(genes_positive, mono_live_h24_inf_exvivo_noebola,ebola_genome_percentage_df_exvivo, keepzeros = T)+ggtitle("EXVIVO")
p_corr_exvivo_positive

# Plot 2 lncRNA negative
genes_negative <- c("ENSMMUG00000064224-unknown", "MSTRG.238227-unknown")
p_corr_exvivo_negative <- visualize_correlation(genes_negative, mono_live_h24_inf_exvivo_noebola,ebola_genome_percentage_df_exvivo, keepzeros = T)+ggtitle("EXVIVO")
p_corr_exvivo_negative

# 3. Visualize in vivo
visualize_correlation(genes, mono_live_h24_inf_invivo_noebola,ebola_genome_percentage_df_invivo, keepzeros = T)+ggtitle("INVIVO")
visualize_correlation_window(genes, mono_live_h24_inf_invivo_noebola,ebola_genome_percentage_df_invivo, keepzeros = T)+ggtitle("INVIVO")

# 4.lncRNA statistics 
significant_lnc <- readRDS(file.path(data_path, "02_scRNA-Seq_PBMCs/00_scRNA-Seq_exVivo_rhemac10_NOVELFILTERTEST/05_RObjects/06_correlation/03_viralload_infected_late/significant_lnc.rds"))

significant_lnc$type <- ifelse(str_detect(significant_lnc$gene, regex("MST")), "novel","annotated")
significant_lnc$corr <- ifelse(significant_lnc$rho < 0, "negative","positive")
ggplot(significant_lnc, aes( x=significant_lnc$corr, fill=as.factor(type))) + geom_bar()+ scale_y_continuous(breaks = seq(0, 14, by = 2))+ theme_paper

```


# 3. Plot bystander vs infected 

```{r imports}
#------------------------ EX VIVO -----------------------------
# 1. Load Ex vivo 
immune.combined <- readRDS(file.path(data_path,"/05_RObjects/03_prep/03_immune.combined.ready.rds"))
print(table(colnames(immune.combined) == rownames(ebola_genome_percentage_df_exvivo)))
# 2. Add infection information
immune.combined$infection <- ebola_genome_percentage_df_exvivo$classification 
immune.combined$viral_load <- ebola_genome_percentage_df_exvivo$percentage_viral_reads 
# 3. Separate  infected and bystanders
infected_cells <- subset(immune.combied, infection == "Infected")
infected_cells <- colnames(infected_cells)
monocytes <- subset(immune.combined, ident = "Monocyte")
baseline <- monocytes[,monocytes$cond == "media"]
late <- monocytes[,monocytes$cond == "live" & monocytes$dpi == "H024"]
infected <- late[,infected_cells]
bystanders <- late[,setdiff(colnames(late), infected_cells)]
# Check 
length(unique(colnames(bystanders))) + length(unique(colnames(infected))) == length(unique(colnames(late)))
#saveRDS(infected, file.path(data_path,"/05_RObjects/03_prep/infected.rds"))
#saveRDS(bystanders, file.path(data_path,"/05_RObjects/03_prep/bystander.rds"))
#saveRDS(baseline,file.path(data_path,"/05_RObjects/03_prep/baseline.rds") )


#------------------------ IN VIVO -----------------------------
immune.combined_invivo <- readRDS(file.path("/home/mariasr/cluster/02.ebola_sc/data/02_scRNA-Seq_PBMCs/01_scRNA-Seq_inVivo_rhemac10/05_RObjects/03_prep/03_immune.combined.ready.rds"))
print(table(colnames(immune.combined_invivo) == rownames(ebola_genome_percentage_df_invivo)))
# 2. Add infection information
immune.combined_invivo$infection <- ebola_genome_percentage_df_invivo$classification 
immune.combined_invivo$viral_load <- ebola_genome_percentage_df_invivo$percentage_viral_reads 
infected_cells <- rownames(ebola_genome_percentage_df_invivo[ebola_genome_percentage_df_invivo$classification == "Infected",])
monocytes_invivo <- subset(immune.combined_invivo, ident = "Monocyte")
baseline_invivo <- monocytes_invivo[,monocytes_invivo$group_dpi %in%c("DPI-04","DPI-30", "DPI000")]
late_invivo <- monocytes_invivo[,monocytes_invivo$group_dpi %in% c("DPI005","DPI006","DPI007","DPI008")]
infected_invivo <- late_invivo[,infected_cells]
bystanders_invivo <- late_invivo[,setdiff(colnames(late_invivo), infected_cells)]
# Check 
length(unique(colnames(bystanders))) + length(unique(colnames(infected))) == length(unique(colnames(late)))
#saveRDS(infected_invivo, file.path(data_path,"/05_RObjects/03_prep/infected_invivo.rds"))
#saveRDS(bystanders_invivo, file.path(data_path,"/05_RObjects/03_prep/bystander_invivo.rds"))
#saveRDS(baseline_invivo, file.path(data_path,"/05_RObjects/03_prep/baseline_invivo.rds"))

#plot infected vs bystander 
test_boxplots <- function(gene){
  p1 <- plot_boxplot_cells(gene,baseline, bystanders, infected, "ex vivo")
  #p2 <- plot_boxplot_cells(gene,baseline_invivo, bystanders_invivo, infected_invivo, "in vivo")
  return(list(p1))
}

# Test example Broad 
test_boxplots("ENSMMUG00000058644-unknown")
test_boxplots("MSTRG.181870-unknown")
test_boxplots("ENSMMUG00000064224-unknown")

```

