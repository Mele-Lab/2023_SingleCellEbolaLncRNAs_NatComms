---
title: "Specificity"
author: "Luisa Santus"
date: "3/16/2020"
output: html_document
---

# Specificity 


```{r include=FALSE}
library(Seurat)
library(gtools)
library(ggplot2)
library(ggpubr)
library(rtracklayer)
library(MatchIt)
library(gridExtra)
library(SingleCellExperiment)
theme_paper <- theme(legend.title = element_blank())+theme(panel.background = element_rect(fill = "white", colour = "white"))+theme(panel.background = element_rect(fill = "white", colour = "grey50"))+theme(axis.text = element_text(size = 18), axis.title = element_text(size = 20), legend.text = element_text(size = 18))
col_lnc = "#870052"
col_mrna = "#2e88bf"
palette_plot_percentage <- c(col_lnc, col_mrna)


robjectsdir <- "/home/luisas/Desktop/cluster/data/02_scRNA-Seq_PBMCs/01_scRNA-Seq_inVivo_rhemac10/05_RObjectsOLD/05_stats/"
all_lncrnas <- readRDS(file.path(robjectsdir, "all_lncrnas.rds"))
annotated_mrnas <- readRDS(file.path(robjectsdir,"annotated_mrnas.rds"))

file <- file.path("/home/luisas/Desktop/cluster/data/02_scRNA-Seq_PBMCs/01_scRNA-Seq_inVivo_rhemac10/05_RObjectsOLD//03_prep/03_immune.combined.ready_no_neut.rds")
immune.combined <- readRDS(file)


length(unique(all_lncrnas))
spec_min_corrected <- readRDS(file.path(robjectsdir, "00_specres_corrected_min_noneut.rds"))
spec_min_notcorrected <- readRDS(file.path(robjectsdir, "00_specres_notcorrected_min_noneut.rds"))
df_lnc <- readRDS(file.path(robjectsdir,"df_lnc.rds"))
df_lnc_celtype <- readRDS(file.path(robjectsdir,"df_celltype_lnc.rds"))
df_mrna <- readRDS(file.path(robjectsdir,"df_mrna.rds"))
df_mrna_celltype <- readRDS(file.path(robjectsdir,"df_mrna_celltype.rds"))
df_n_cells <- rbind(df_lnc, df_mrna)
df_celltype <- rbind(df_mrna_celltype,df_lnc_celtype )
spec_min_corrected_new <- readRDS("/home/luisas/Desktop/cluster/data/02_scRNA-Seq_PBMCs/01_scRNA-Seq_inVivo_rhemac10/05_RObjectsOLD/05_stats/00_specificity_permutation/specificity_real.rds")

marker.genes <- readRDS("/home/luisas/Desktop/cluster/data/02_scRNA-Seq_PBMCs/01_scRNA-Seq_inVivo_rhemac10/05_RObjectsOLD/03_prep/marker.genes.rds")

theme_sc <- theme(axis.title.x.top = element_text())+theme_minimal()+ theme(panel.background = element_rect(fill = "white", colour = "grey50"), panel.grid.major = element_blank(), panel.grid.minor = element_blank())+theme(axis.title = element_text(size=15), plot.title = element_text(size =22, hjust = 0.5))

housekeeping_genes <- c("RRN18S", "RPLP0", "GAPDH", "ACTB", "PGK1", "RPL13A", "ARBP", "B2M", "YWHAZ", "SDHA", "TFRC", "GUSB", "HMBS", "HPRT1", "TBP")
```


# Try with normalization and FC super basic
```{r cars}
# ----------------------------------------------------------------
#   In order to rertieve the number of cells in which they express 
# ----------------------------------------------------------------


get_df_summary <-function(spec_res){
  rownames(spec_res) <- spec_res$gene
  spec_res$type <- "other"
  spec_res[all_lncrnas,]$type<- "lnc"
  spec_res[annotated_mrnas,]$type<- "pc"
  spec_res$log <- log(spec_res$score)

  spec_res_int <- spec_res[spec_res$type %in% c("lnc", "pc"),]
  df_test <- merge(spec_res_int, df_n_cells, by = "row.names")
  
  # Only keep genes that show expression in at least 30 cells.
  df_test <- df_test[df_test$n_cells > 30, ]
  df_test <- df_test[df_test$log != "Inf",]
  df_test <- df_test[!is.na(df_test$Row.names),]
  
  rownames(df_test) <- df_test$`Row.names`
  return(df_test)
}

spec_min_corrected_df <- get_df_summary(spec_min_corrected)
spec_min_notcorrected_df <- get_df_summary(spec_min_notcorrected)
spec_min_corrected_new_df <- get_df_summary(spec_min_corrected_new)

max(spec_min_corrected_df$score)
max(spec_min_corrected_new_df$score)


# How many lnc do i find in the object 
spec_res <- spec_min_corrected
```

```{r cars}
# ---------------------------------------------------------
#                    Plot Markers 
# ---------------------------------------------------------

marker_genes_plot <- function(df_test, title){
  highlight_df <- df_test[rownames(df_test) %in% marker.genes, ]
  highlight_df_hk <- df_test[rownames(df_test) %in% housekeeping_genes_3k, ]

  p1 <- ggplot(df_test, aes(x = log , y = n_cells, col = type))+scale_color_manual(values = (palette_plot_percentage))
  p1 <- p1+geom_point(size = 0.1)+theme_classic()+theme_paper+
           geom_point(data=highlight_df, aes(x=log,y=n_cells), color='red',size=2)+ggtitle(title)+geom_point(data=highlight_df_hk, aes(x=log,y=n_cells), color='#006600',size=2)
  return(p1)
}

my_comparisons <- list(c("lnc", "novel"), c("lnc", "pc"), c("pc", "novel"))
marker_genes_plot <- function(df_test, title){
  highlight_df <- df_test[rownames(df_test) %in% marker.genes, ]
  highlight_df_hk <- df_test[rownames(df_test) %in% housekeeping_genes_3k, ]

  p1 <- ggboxplot(df_test, x = "type", y = "log",  col="type", fill = "type", alpha= 0.5) +
                theme_paper+scale_color_manual(values = rev(palette_plot_percentage))+
                scale_fill_manual(values = rev(palette_plot_percentage))+
                theme(legend.position = "none")+
                stat_compare_means(comparisons = my_comparisons)+
                labs(y = "Specificity", x = "")
  p1 <- p1+geom_point(data=highlight_df, aes(x=type,y=log), color='red',size=1)+ggtitle(title)+geom_point(data=highlight_df_hk, aes(x=type,y=log), color='#009900',size=1)+theme_sc
  return(p1)
}

marker_genes_plot <- function(df_test, title){
  highlight_df <- df_test[rownames(df_test) %in% marker.genes, ]
  highlight_df_hk <- df_test[rownames(df_test) %in% housekeeping_genes_3k, ]

  p1 <- ggdensity(df_test, x = "log",  col="type", fill = "type", alpha= 0.5) +
                theme_paper+scale_color_manual(values = rev(palette_plot_percentage))+
                scale_fill_manual(values = rev(palette_plot_percentage))
  
  return(p1)
}

df_test <- spec_min_notcorrected_df
df_test <- spec_min_corrected_df

housekeeping_genes_3k <- df_test[housekeeping_genes, ][!is.na(df_test[housekeeping_genes, ]$n_cells) & df_test[housekeeping_genes, ]$n_cells>3000,]$gene

# Scale
df_test <- spec_min_corrected_new_df

range01 <- function(x){(x-min(x))/(max(x)-min(x))}
df_test$log <- range01(df_test$log)
my_comparisons <- list( c("lnc", "pc"))
marker_genes_plot(df_test,"Min Corrected" )

# Separate Novel and Annotated Lnc
my_comparisons <- list(c("lnc", "novel"), c("lnc", "pc"), c("pc", "novel"))
palette_plot_percentage <- c("orange", palette_plot_percentage)
df_test[marker.genes, ]$type <- "pc"
df_test[substr(df_test$gene,1,5) == "MSTRG",]$type <- "novel"
marker_genes_plot(df_test, "")
table(df_test$type)

# ---------------------------------------------------------------------------------------------------
# The specificity score is correlated with the number of cells in which the gene is expressed
# ---------------------------------------------------------------------------------------------------
ggscatter(df_test, x = "log", y = "n_cells", 
          add = "reg.line", conf.int = T, 
          cor.coef = TRUE, cor.method = "spearman", size=0.3, col = "#999999",add.params = list(color = "red", size = 0.3))+theme_sc+labs(x = "Specificity Score", y = "Number of cells")



df_test[marker.genes, ]
```




```{r cars}
df_test_max <- df_test[df_test$log %in% tail(sort(df_test$log),6), ]
df_test_min <- df_test[df_test$log %in% head(sort(df_test$log),6), ]
df_test_max_lnc <- df_test[df_test$type == "lnc",]
df_test_max_lnc <- df_test_max_lnc[df_test_max_lnc$log %in% tail(sort(df_test_max_lnc$log),6),]
df_test_max_pc <- df_test[df_test$type == "pc",]
df_test_max_pc <- df_test_max_pc[df_test_max_pc$log %in% tail(sort(df_test_max_pc$log),6),]

lapply(df_test_max_lnc$gene, function(gene) FeaturePlot(immune.combined, gene, pt.size=1.2, order = T, cols
                                                        = c("gray", col_lnc ))+theme_sc)

lapply(df_test_max_pc$gene, function(gene) FeaturePlot(immune.combined, gene, pt.size=1.2, order = T, cols
                                                        = c("gray", col_mrna ))+theme_sc)

lapply(marker.genes, function(gene) FeaturePlot(immune.combined, gene, pt.size=1.2, order = T )+theme_sc)

lapply(housekeeping_genes_3k, function(gene) FeaturePlot(immune.combined, gene, order = T )+theme_sc)

lapply(df_test_max$gene, function(gene) FeaturePlot(immune.combined, gene, order = T )+theme_sc)
lapply(df_test_min$gene, function(gene) FeaturePlot(immune.combined, gene, order = T )+theme_sc)

```


# -------------------------------------------------
#             Matching ananlysis
# -------------------------------------------------


# Match by the percentage of cells expressing
```{r matchmedian}
palette_plot_percentage <- c(col_lnc, col_mrna)

set.seed(123)

c <- df_test[complete.cases(df_test),]
c$type = ifelse(c$type == "lnc", 1, 0)
table(c$type)
table(df_test$type)
# match expression 
mi_median <- matchit(type ~ perc_cells_expressing,c)
matches_median <- get_matches(mi_median, c)

# Calculate p-value 
#perc_cells_0 <- matches_median[matches_median$type == 0,]$log
#perc_cells_1 <- matches_median[matches_median$type == 1,]$log
#t.test(perc_cells_0, perc_cells_1)


matches_median$type = ifelse(matches_median$type == 0, "mrna", "lnc")
n_matches <- length(unique(matches_median[matches_median$type == "lnc",]$gene_id))
matches_median$type <- as.factor(matches_median$type)

# Plot 
scatter_plot_matching <- ggplot(matches_median, aes(x=log, y =perc_cells_expressing, col = as.factor(type)))+geom_point(size = 0.8)+labs( subtitle = paste0("# Matches ", n_matches))+scale_fill_manual(values = palette_plot_percentage)+
          scale_color_manual(values = palette_plot_percentage)+theme(panel.background = element_rect(fill = "white", colour = "grey50"))+theme(axis.text = element_text(size = 15), axis.title = element_text(size = 22), legend.text = element_text(size = 18))+xlab("Specificity Score")

scatter_plot_matching_withboxplot<- ggExtra::ggMarginal(scatter_plot_matching,type = 'boxplot',margins = "both",size = 3,colour = "darkgrey", alpha = 0.3,groupColour = TRUE, groupFill = TRUE)
scatter_plot_matching_withboxplot

```






# Match by the percentage of cells expressing
```{r matchmedian}
palette_plot_percentage <- c(col_lnc, col_mrna)

set.seed(123)

c <- df_test[complete.cases(df_test),]
c$type = ifelse(c$type == "lnc", 1, 0)
table(c$type)
table(df_test$type)
# match expression 
mi_median <- matchit(type ~ log,c)
matches_median <- get_matches(mi_median, c)



matches_median$type = ifelse(matches_median$type == 0, "mrna", "lnc")
n_matches <- length(unique(matches_median[matches_median$type == "lnc",]$gene_id))
matches_median$type <- as.factor(matches_median$type)

# Plot 
scatter_plot_matching <- ggplot(matches_median, aes(x=log, y =perc_cells_expressing, col = as.factor(type)))+geom_point(size = 0.8)+labs( subtitle = paste0("# Matches ", n_matches))+scale_fill_manual(values = palette_plot_percentage)+
          scale_color_manual(values = palette_plot_percentage)+theme(panel.background = element_rect(fill = "white", colour = "grey50"))+theme(axis.text = element_text(size = 15), axis.title = element_text(size = 22), legend.text = element_text(size = 18))+theme(legend.position = "")

scatter_plot_matching_withboxplot<- ggExtra::ggMarginal(scatter_plot_matching,type = 'boxplot',margins = "both",size = 3,colour = "darkgrey", alpha = 0.3,groupColour = TRUE, groupFill = TRUE)
scatter_plot_matching_withboxplot




```


# -------------------------------------------------
#            Permutation analysis
# -------------------------------------------------

In order to exclude the hypothesis that the number of cells drives the higher specificity score obtained for lnc, 

```{r matchmedian}

permutation_files <- iterate_files("/home/luisas/Desktop/cluster/data/02_scRNA-Seq_PBMCs/01_scRNA-Seq_inVivo_rhemac10/05_RObjectsOLD/05_stats/00_specificity_permutation/","Permutations*")

perm <- readRDS("/home/luisas/Desktop/cluster/data/02_scRNA-Seq_PBMCs/01_scRNA-Seq_inVivo_rhemac10/05_RObjectsOLD/05_stats/00_specificity_permutation/Permutations_100.rds")

# Permuted
perm <- get_df_summary(perm)
perm <- perm[perm$score != Inf,]

# Real 
df_test <- spec_min_corrected_new_df

df <- data.frame( score = perm$log , type = "Permuted Cell-types", genetype =perm$type )
df1 <- data.frame(score = df_test$log, type = "Real Data ", genetype =df_test$type)
df_tot <- rbind(df, df1)
df_tot$score <- range01(df_tot$score )



# Compare Lnc and PC between permuted and real 
# I want them to be UNSIGNIFICANT in the permuted and SIGNIFICANT in the real 
palette_plot_percentage <- c(col_lnc, col_mrna)
my_comparisons <- list( c("lnc", "pc"))

ggboxplot(df_tot, x = "genetype", y = "score",  col="genetype", fill = "genetype", alpha= 0.5, facet.by = "type", short.panel.labs = T) +
                theme_paper+scale_color_manual(values = (palette_plot_percentage))+
                scale_fill_manual(values = (palette_plot_percentage))+
                theme(legend.position = "none")+
                stat_compare_means(comparisons = my_comparisons)


# Take an example
gene <- perm[perm$score == max(perm$score),]$gene
FeaturePlot(immune.combined, gene)
perm[gene, ]
df_test[gene, ]


n_cell_celltype <- df_celltype[df_celltype$gene_id == gene & df_celltype$ident == "Myeloid",]$n_cells
df_test[gene, ]$score * n_cell_celltype


c_density_plot <- ggplot(df_tot, aes(score, col = type )) + stat_ecdf(geom = "step", size = 1)+theme_paper+xlab("Specificity score")+ylab("")+ggtitle("Cumulative density plot")+scale_color_viridis_d() 


c_density_plot <- ggplot(df_tot, aes(score, col = type )) + geom_s(geom = "step", size = 1)+theme_paper+xlab("Specificity score")+ylab("")+ggtitle("Cumulative density plot")+scale_color_viridis_d() 

ggExtra::ggMarginal(c_density_plot,type = 'boxplot',margins = "x",size = 3,colour = "darkgrey", alpha = 0.3,groupColour = TRUE, groupFill = TRUE)

ggplot(df_tot, aes(y=score,x = type,  col = type, fill = type )) + geom_boxplot(alpha = 0.5)+theme_paper+xlab("Specificity score")+ylab("")+scale_color_viridis_d()+scale_fill_viridis_d()+theme(axis.text.x = element_blank())


```

