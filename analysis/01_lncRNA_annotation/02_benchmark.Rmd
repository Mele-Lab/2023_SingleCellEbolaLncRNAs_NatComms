---
title: "01_lncrnas_plots_paper"
author: "Luisa Santus"
date: "4/23/2020"
output: html_document
  keep_md: true
---

## Test prediction tools on real annotation 

# Read all the prediciton and reference files
```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rtracklayer);  library(stringr); library(ggplot2); library(grid); library(gridExtra); library(RColorBrewer); library(readr); library(matrixStats)
library(GenomicRanges); library(dplyr); library(zeallot); library(tximport); library(ggpubr); library(plyr); 
library(formattable)
library(DT)

# Import Utils
source(file.path("../utils/01_lncrna_annotation_utils.R"))


# Human reference for comparison
ref <- import(file.path("/home/luisas/Desktop/cluster/gene_annotations/ensembl_release100/rheMac10/Macaca_mulatta.Mmul_10.100.gtf"))

ref_lnc <- ref[ref$transcript_biotype %in% c("lncRNA", "antisense"),]
ref_lnc <- ref_lnc[ref_lnc$type == "transcript", ]
ref_pc <- ref[ref$type == "transcript" & ref$transcript_biotype == "protein_coding",]

# ----------------------
#   CPC2 predictions
# ----------------------
cpc2 <- read.table(file.path("/home/luisas/Desktop/cluster/data/01_bulk_RNA-Seq_lncRNAs_annotation/03_novel_lncRNAs_list/99_benchmark_annotation/01_predictions/CPC2/cpc2_pred.txt"))
names(cpc2) <- c("ID","transcript_length ","peptide_length","Fickett_score" , " pI", "ORF_integrity", "coding_probability","label")
# Extract transcript ids 
cpc2$transcript_id <- unlist(lapply(as.character(cpc2$ID), function(x) strsplit(x,"[(]")[[1]][1]))

# ----------------------
#   CPAT predictions
# ----------------------
cpat <- read.table(file.path("/home/luisas/Desktop/cluster/data/01_bulk_RNA-Seq_lncRNAs_annotation/03_novel_lncRNAs_list/99_benchmark_annotation/01_predictions/CPAT/cpat_pred.ORF_prob.tsv"), header = T)
cutoff <-  0.364
cpat$label <- ifelse(cpat$Coding_prob > cutoff, "coding", "noncoding")

# ----------------------
#   CNIT predictions
# ----------------------
cnit <- read.table(file.path("/home/luisas/Desktop/cluster/data/01_bulk_RNA-Seq_lncRNAs_annotation/03_novel_lncRNAs_list/99_benchmark_annotation/01_predictions/CNIT/cnit_pred/CNCI2.index"), header = T, sep="\t", stringsAsFactors = F)



# How many of the known lncRNAs are identified as such 
noncoding_cpc2 <- unlist(lapply(cpc2[cpc2$label == "noncoding",]$ID, function(x) strsplit(as.character(x),'(', fixed = T)[[1]][1]))
coding_cpc2 <- unlist(lapply(cpc2[cpc2$label == "coding",]$ID, function(x) strsplit(as.character(x),'(', fixed = T)[[1]][1]))

noncoding_cpat <- unlist(lapply(cpat[cpat$label == "noncoding",]$ID, function(x) strsplit(as.character(x),'(', fixed = T)[[1]][1]))
coding_cpat <- unlist(lapply(cpat[cpat$label == "coding",]$ID, function(x) strsplit(as.character(x),'(', fixed = T)[[1]][1]))

noncoding_cnit <- unlist(lapply(cnit[cnit$index == "noncoding",]$Transcript.ID, function(x) strsplit(as.character(x),'(', fixed = T)[[1]][1]))
coding_cnit <- unlist(lapply(cnit[cnit$index == "coding",]$Transcript.ID, function(x) strsplit(as.character(x),'(', fixed = T)[[1]][1]))
```



```{r include=FALSE}
# How many lncRNAs in total in the annotation 
length(unique(ref_lnc$transcript_id))
length(unique(ref_lnc$gene_id))


calc_stats_prediction <- function(noncoding_pred,coding_pred, name){
  # Predicted as lnc and and are lnc
  TP <- length(unique(ref_lnc[ref_lnc$transcript_id %in% noncoding_pred,]$transcript_id))
  print(TP)
  # Predicted as pc but are lnc
  FN <- length(unique(ref_lnc[ref_lnc$transcript_id %in% coding_pred,]$transcript_id))
  print(FN)
  # Predicted as pc and are pc
  TN <- length(unique(ref_pc[ref_pc$transcript_id %in% coding_pred,]))
  # Predicted as lnc but are pc
  FP <- length(unique(ref_pc[ref_pc$transcript_id %in% noncoding_pred,]))
  sensitivity <- (TP/(FN+TP))*100
  specificity <- (TN/(TN+FP))*100
  accuracy <- ((TP + TN)/(TP + TN + FP + FN))*100 
  df <- data.frame(name = name, sensitivity = sensitivity, specificity = specificity, accuracy = accuracy, stringsAsFactors = F)
  return(df)
}

noncoding_intersection <- unique(intersect(noncoding_cpc2,intersect(noncoding_cnit, noncoding_cpat)))
coding_intersection <- unique(ref[!(ref$transcript_id %in% noncoding_intersection), ]$transcript_id)

noncoding_union <- unique(union(noncoding_cpc2,union(noncoding_cnit, noncoding_cpat)))
coding_union <- unique(ref[!(ref$transcript_id %in% noncoding_intersection), ]$transcript_id)

cpc2_stats <- calc_stats_prediction(noncoding_cpc2, coding_cpc2, "CPC2")
cpat_stats <- calc_stats_prediction(noncoding_cpat, coding_cpat, "CPAT")
cnit_stats <- calc_stats_prediction(noncoding_cnit, coding_cnit, "CNIT")
intersection_stats <- calc_stats_prediction(noncoding_intersection, coding_intersection, "Intersection")
union_stats <- calc_stats_prediction(noncoding_union, coding_union, "Union")

stats_summary <- rbind(cpc2_stats, cpat_stats, cnit_stats, intersection_stats, union_stats)

formattable(stats_summary, 
            align = c("l",rep("r", NCOL(stats_summary) - 1)),
            list(`name` = formatter("span", style = ~ style(color = "grey", font.weight = "bold")), 
                 area(col = c(accuracy)) ~ normalize_bar("#E5CCFF", 0.2)))

```




```{r include=FALSE}
annotated_reduced <- unique(ref_lnc[ref_lnc$transcript_id %in% c(noncoding_cpat, noncoding_cpc2, noncoding_cnit),]$transcript_id)

annotated_lnc <- unique(ref_lnc$transcript_id)

listInput <- list(cpat = unique(noncoding_cpat[noncoding_cpat %in% annotated_reduced]), CPC2 = unique(noncoding_cpc2[noncoding_cpc2 %in% annotated_reduced]), CNIT = unique(noncoding_cnit[noncoding_cnit %in% annotated_reduced]),  annotated = annotated_lnc )

library(eulerr)
library(ComplexHeatmap)
plot(euler(listInput, shape = "ellipse"),
     quantities = TRUE,
     edges = list(lty = 3), 
     legend = list(side = "right")
    )
upset(fromList(listInput), order.by = "freq",text.scale = 1.9,  main.bar.color = c("#6600cc", rep("gray23",7)))


```


